{% extends "base.html" %}
{% load static %}

{% block title %}Driver Dashboard - TSafari{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'motorbike/css/driver_dashboard.css' %}">

<section class="dashboard-bg">
  <div class="dashboard-container-2col">
    
    <!-- LEFT COLUMN -->
    <div class="dashboard-left">
      <h2 class="dashboard-title">Welcome, {{ driver_name }}</h2>
      <p class="dashboard-description">Manage your availability and visibility.</p>

      <!-- Driver Info -->
      <div class="driver-info">
        <p><strong>Name:</strong> {{ driver_name }}</p>
        <p><strong>Phone:</strong> {{ driver_phone }}</p>
        <p><strong>Sacco:</strong> {{ driver_sacco }}</p>
        <p><strong>Stage:</strong> {{ driver_stage }}</p>
        <p><strong>Rating:</strong> {{ driver_rating }} ‚≠ê</p>
      </div>

      <!-- Availability -->
      <div class="availability-section">
        <label class="availability-toggle">
          <input type="checkbox" id="availabilityCheckbox" {% if is_available %}checked{% endif %} onchange="toggleAvailability(this)">
          <span class="slider"></span>
        </label>
        <span id="availabilityText">
          Currently: 
          <strong class="{% if is_available %}text-green{% endif %}">
            {% if is_available %}Available{% else %}Unavailable{% endif %}
          </strong>
        </span>
      </div>

      <div id="locationStatus" class="location-status {% if not is_available %}hidden{% endif %}">
        üìç Your location is being shared with customers.
      </div>

      <!-- Account Links -->
      <div class="account-links">
        <a href="{% url 'edit_account' %}">‚úèÔ∏è Edit Account Details</a><br>
        <a href="{% url 'mini_statements' %}">üìÑ View Mini Statements</a>
      </div>
    </div>

    <!-- RIGHT COLUMN -->
    <div class="dashboard-right">
      <div class="summary-box">
        <h3>Today's Summary</h3>
        <p>Rides Completed: {{ rides_completed }}</p>
        <p>Earnings: KES {{ earnings }}</p>
        <p>Pending Requests: {{ pending_requests }}</p>
        <button class="withdraw-btn">üí∏ Withdraw</button>
      </div>
    </div>

  </div>
</section>

<script>
  function toggleAvailability(checkbox) {
    const text = document.getElementById("availabilityText");
    const locationStatus = document.getElementById("locationStatus");

    const isChecked = checkbox.checked;
    text.innerHTML = `Currently: <strong class="${isChecked ? 'text-green' : ''}">${isChecked ? 'Available' : 'Unavailable'}</strong>`;
    locationStatus.classList.toggle("hidden", !isChecked);

    fetch("{% url 'toggle_availability' %}", {
      method: "POST",
      headers: {
        "X-CSRFToken": "{{ csrf_token }}",
        "Content-Type": "application/json"
      },
      body: JSON.stringify({})
    }).then(res => res.json()).then(data => {
      if (data.status !== 'success') {
        alert("Failed to update availability");
        checkbox.checked = !isChecked; // revert
        toggleAvailability(checkbox);  // retry
      }
    });

    if (isChecked) {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (position) => {
            console.log("Lat:", position.coords.latitude);
            console.log("Lng:", position.coords.longitude);
            // TODO: Send location to backend if needed
          },
          (error) => {
            alert("Location access denied.");
            checkbox.checked = false;
            toggleAvailability(checkbox);
          }
        );
      } else {
        alert("Geolocation not supported.");
      }
    }
  }
</script>
{% endblock %}
