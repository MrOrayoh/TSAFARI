{% extends "base.html" %}
{% load static %}

{% block title %}Driver Dashboard - TSafari{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'motorbike/css/driver_dashboard.css' %}">

<section class="dashboard-bg">
  <div class="dashboard-container-2col">
    
    <div class="dashboard-left">
      <h2 class="dashboard-title">Welcome, {{ driver_name }}</h2>
      <p class="dashboard-description">Manage your availability and visibility.</p>

      <div class="driver-info">
        <p><strong>Name:</strong> {{ driver_name }}</p>
        <p><strong>Phone:</strong> {{ driver_phone }}</p>
        <p><strong>Sacco:</strong> {{ driver_sacco }}</p>
        <p><strong>Stage:</strong> {{ driver_stage }}</p>
        <p><strong>Rating:</strong> {{ driver_rating }} ⭐</p>
      </div>

      <div class="availability-section">
        <label class="availability-toggle">
          <input type="checkbox" id="availabilityCheckbox" {% if is_available %}checked{% endif %} onchange="toggleAvailability(this)">
          <span class="slider"></span>
        </label>
        <span id="availabilityText">
          Currently: 
          <strong class="{% if is_available %}text-green{% endif %}">
            {% if is_available %}Available{% else %}Unavailable{% endif %}
          </strong>
        </span>
      </div>

      <div id="locationStatus" class="location-status {% if not is_available %}hidden{% endif %}">
        📍 Your location is being shared with customers.
      </div>

      <div class="account-links">
        <a href="{% url 'edit_account' %}">✏️ Edit Account Details</a><br>
        <a href="{% url 'mini_statements' %}">📄 View Mini Statements</a>
      </div>
    </div>

    <div class="dashboard-right">
      <div class="summary-box">
        <h3>Today's Summary</h3>
        <p>Rides Completed: {{ rides_completed }}</p>
        <p>Earnings: KES {{ earnings }}</p>
        <p>Pending Requests: {{ pending_requests }}</p>
        <button class="withdraw-btn">💸 Withdraw</button>
      </div>
    </div>

  </div>
</section>

<script>
  function toggleAvailability(checkbox) {
    const text = document.getElementById("availabilityText");
    const locationStatus = document.getElementById("locationStatus");
    const isChecked = checkbox.checked;

    text.innerHTML = `Currently: <strong class="${isChecked ? 'text-green' : ''}">${isChecked ? 'Available' : 'Unavailable'}</strong>`;
    locationStatus.classList.toggle("hidden", !isChecked);

    if (isChecked) {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (position) => {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;

            fetch("{% url 'toggle_availability' %}", {
              method: "POST",
              headers: {
                "X-CSRFToken": "{{ csrf_token }}",
                "Content-Type": "application/json"
              },
              body: JSON.stringify({
                is_available: true,
                latitude: lat,
                longitude: lng
              })
            }).then(res => res.json()).then(data => {
              if (data.status !== 'success') {
                alert("Failed to update availability");
                checkbox.checked = false;
                toggleAvailability(checkbox);
              }
            });
          },
          (error) => {
            alert("Location access denied.");
            checkbox.checked = false;
            toggleAvailability(checkbox);
          }
        );
      } else {
        alert("Geolocation not supported.");
        checkbox.checked = false;
        toggleAvailability(checkbox);
      }
    } else {
      fetch("{% url 'toggle_availability' %}", {
        method: "POST",
        headers: {
          "X-CSRFToken": "{{ csrf_token }}",
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ is_available: false })
      }).then(res => res.json()).then(data => {
        if (data.status !== 'success') {
          alert("Failed to update availability");
        }
      });
    }
  }
</script>
{% endblock %}
